package io.reflection.salesdatagather;

import io.reflection.salesdatagather.model.DataAccount;
import io.reflection.salesdatagather.model.repositories.DataAccountRepository;
import io.reflection.salesdatagather.model.repositories.SaleItemRepository;
import io.reflection.salesdatagather.services.GatherTaskService;

import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

@Service
public class NicksHelper {
	private transient static final Logger LOG = LoggerFactory.getLogger(NicksHelper.class.getName());

	@Autowired
	private DataAccountRepository					dataAccountRepo;

	@Autowired
	private SaleItemRepository						saleItemRepo;

	@Autowired
	private GatherTaskService							gatherTaskService;

	public void run() {
		int[][] accountItemsToProcess = getAccountItems();
		HashMap<Integer, DataAccount> loadedDataAccountsById = new HashMap<Integer, DataAccount>(52);


		for(int accountIndex = 0;accountIndex<accountItemsToProcess.length;accountIndex++) {
			int[] accountIdAndMainItemId = accountItemsToProcess[accountIndex];

			DataAccount activeAccount = null;

			int accountId = accountIdAndMainItemId[0];

			if(loadedDataAccountsById.containsKey(accountId)) {
				activeAccount = loadedDataAccountsById.get(accountId);
			}else {
				activeAccount = dataAccountRepo.getDataAccountById(accountId);
				loadedDataAccountsById.put(accountId, activeAccount);
			}

			String mainItemId = String.valueOf(accountIdAndMainItemId[1]);

			Calendar cal = Calendar.getInstance();
			cal.set(2015, 5, 1);
			Date from = cal.getTime();

			cal.add(Calendar.MONTH, 1);
			cal.add(Calendar.DAY_OF_MONTH, -1);
			Date to = cal.getTime();

			LOG.debug(String.format("Processing active account: %s from %s to %s", activeAccount.getUsername(), from, to));

			List<String> iapIdsForItem = saleItemRepo.getIAPIdsForItem(activeAccount.getId(), mainItemId);

			String itemIds = StringUtils.collectionToCommaDelimitedString(iapIdsForItem);

			try {
				gatherTaskService.scheduleTaskForExecution(activeAccount, from, to, itemIds, mainItemId, "gb");
			} catch (Exception e) {
				LOG.error("Error occured while trying to process sales for data account: "+accountId+" mainItemId: "+mainItemId+", itemIds: "+itemIds.toString());
			}
		}
	}

	private int[][] getAccountItems() {
		return new int[][]{{264, 942494098},
				{264, 543186831},
				{332, 582654048},
				{331, 490952152},
				{321, 595558452},
				{346, 505157905},
				{338, 459035295},
				{331, 472315002},
				{256, 708600202},
				{264, 826523703},
				{331, 901366161},
				{360, 910492448},
				{332, 686542963},
				{332, 794507331},
				{259, 461402734},
				{259, 594802437},
				{332, 870558917},
				{369, 961677403},
				{333, 770903376},
				{332, 316050001},
				{329, 922442410},
				{346, 407951439},
				{369, 814977594},
				{332, 347415188},
				{332, 429208823},
				{332, 454316134},
				{332, 944235778},
				{346, 976052433},
				{346, 942926747},
				{347, 933236570},
				{332, 567533074},
				{264, 484990128},
				{340, 421864154},
				{259, 645949180},
				{329, 688881569},
				{348, 711455226}
		};

		//				{1, 429903190},
		//				{211, 336353151},
		//				{256, 504265646},
		//				{256, 581331897},
		//				{256, 708600202},
		//				{256, 771010934},
		//Toca password needs to be updated.
		//				{257, 424174500},
		//				{257, 424209938},
		//				{257, 426382105},
		//				{257, 430807236},
		//				{257, 430807533},
		//				{257, 430811216},
		//				{257, 432858701},
		//				{257, 434826169},
		//				{257, 442705759},
		//				{257, 469933147},
		//				{257, 476553281},
		//				{257, 481623941},
		//				{257, 495680460},
		//				{257, 510301841},
		//				{257, 521640355},
		//				{257, 521640648},
		//				{257, 556430416},
		//				{257, 569631758},
		//				{257, 569632660},
		//				{257, 652077009},
		//				{257, 689936776},
		//				{257, 718082838},
		//				{257, 730873197},
		//				{257, 748057890},
		//				{257, 808108897},
		//				{257, 871694174},
		//				{257, 893927401},
		//				{257, 919097064},
		//				{257, 943869618},
		//				{257, 988318940},
		//				{259, 461402734}, //Diamond Dash - Wooga
		//				{259, 531354582},
		//				{259, 542131161},
		//				{259, 594802437},
		//				{259, 645949180},
		//				{259, 924907196},
		//				{259, 938120844},
		//				{259, 969456511},
		//				{259, 978368808},
		//				{264, 337457680},
		//				{264, 359839935},
		//				{264, 373046496},
		//				{264, 376620803},
		//				{264, 393873119},
		//				{264, 398348506},
		//				{264, 404182204},
		//				{264, 404887288},
		//				{264, 405228647},
		//				{264, 405229087},
		//				{264, 407775125},
		//				{264, 407960696},
		//				{264, 409315620},
		//				{264, 410553807},
		//				{264, 413515700},
		//				{264, 422268550},
		//				{264, 423803502},
		//				{264, 427633070},
		//				{264, 429431260},
		//				{264, 447092952},
		//				{264, 447333710},
		//				{264, 460027948},
		//				{264, 460028314},
		//				{264, 471833761},
		//				{264, 474173782},
		//				{264, 474176948},
		//				{264, 484989542},
		//				{264, 484990128},
		//				{264, 484991325},
		//				{264, 501943783},
		//				{264, 501943923},
		//				{264, 501947104},
		//				{264, 503507752},
		//				{264, 503507960},
		//				{264, 516534997},
		//				{264, 516535540},
		//				{264, 516535756},
		//				{264, 516535942},
		//				{264, 531073963},
		//				{264, 531728867},
		//				{264, 543186831},
		//				{264, 548296798},
		//				{264, 551577067},
		//				{264, 551578353},
		//				{264, 558797517},
		//				{264, 581183720},
		//				{264, 604823043},
		//				{264, 765447392},
		//				{264, 766380107},
		//				{264, 769737983},
		//				{264, 794957821},
		//				{264, 826523703},
		//				{264, 850256671},
		//				{264, 870423065},
		//				{264, 942494098},
		//				{289, 428832518},
		//				{289, 961648314},
		//				{289, 994440204},
		//				{321, 595558452},
		//				{321, 596006531},
		//				{321, 598938741},
		//				{321, 598945891},
		//				{322, 853048509},
		//				{322, 946904664},
		//				{323, 627702899},
		//				{323, 732947385},
		//				{324, 689165391},
		//				{328, 449427775},
		//				{328, 557935078},
		//				{328, 568428630},
		//				{328, 573508067},
		//				{328, 593449762},
		//				{328, 806137586},
		//				{328, 987633815},
		//				{329, 365515521},
		//				{329, 386176717},
		//				{329, 400923918},
		//				{329, 422046876},
		//				{329, 454128392},
		//				{329, 483554913},
		//				{329, 542138524},
		//				{329, 643652199},
		//				{329, 648889339},
		//				{329, 688881569},
		//				{329, 787141016},
		//				{329, 919901057},
		//				{329, 922442410},
		//				{329, 932762376},
		//				{330, 342696845},
		//				{330, 474181227},
		//				{330, 474182372},
		//				{330, 566286915},
		//				{330, 609011789},
		//				{330, 638218699},
		//				{330, 657423319},
		//				{331, 472315002},
		//				{331, 472344174},
		//				{331, 490129379},
		//				{331, 490952152},
		//				{331, 901366161},
		//				{332, 316050001},
		//				{332, 347415188},
		//				{332, 373649156},
		//				{332, 392788790},
		//				{332, 429208823},
		//				{332, 454316134},
		//				{332, 478899198},
		//				{332, 499885330},
		//				{332, 517271093},
		//				{332, 553921725},
		//				{332, 567533074},
		//				{332, 572962048},
		//				{332, 582654048},
		//				{332, 587121382},
		//				{332, 599937501},
		//				{332, 656493344},
		//				{332, 686542963},
		//				{332, 786607135},
		//				{332, 794507331},
		//				{332, 794528112},
		//				{332, 834555725},
		//		{332, 870558917}, // Football Manager Handheld 2015 - Sega
		//				{332, 944235778},
		//				{332, 970254344},
		//				{333, 770903376},
		//				{333, 794226970},
		//				{333, 824373504},
		//				{333, 914059968},
		//				{333, 945704196},
		//				{333, 956129394},
		//				{334, 480956504},
		//				{334, 556826928},
		//				{334, 602403667},
		//				{334, 835969177},
		//				{335, 892809783},
		//				{338, 459035295},
		//				{340, 421864154},
		//				{340, 492670236},
		//				{340, 544695238},
		//				{340, 547938697},
		//				{340, 548567041},
		//				{340, 564769273},
		//				{340, 575835825},
		//				{340, 597793623},
		//				{340, 613163925},
		//				{340, 613164161},
		//				{340, 666354171},
		//				{340, 736051042},
		//				{340, 740488897},
		//				{340, 816303887},
		//				{340, 932308901},
		//				{343, 820396086},
		//				{343, 892834804},
		//				{344, 520888232},
		//				{344, 578248193},
		//				{344, 815581929},
		//				{346, 343384943},
		//				{346, 346833718},
		//				{346, 362313379},
		//				{346, 376185273},
		//				{346, 376189470},
		//				{346, 376194987},
		//				{346, 376363812},
		//				{346, 376370777},
		//				{346, 380081746},
		//				{346, 385944743},
		//				{346, 385946194},
		//				{346, 396116805},
		//				{346, 404556035},
		//				{346, 405042216},
		//				{346, 405057839},
		//				{346, 405518984},
		//				{346, 406156183},
		//				{346, 406169935},
		//				{346, 406176997},
		//				{346, 407779747},
		//				{346, 407951439},
		//				{346, 407951512},
		//				{346, 408849886},
		//				{346, 410595313},
		//				{346, 444080922},
		//				{346, 444833037},
		//				{346, 470165303},
		//				{346, 479980896},
		//				{346, 481623617},
		//				{346, 487247465},
		//				{346, 487249786},
		//				{346, 505157905},
		//				{346, 520032456},
		//				{346, 522348885},
		//				{346, 527622729},
		//				{346, 530140661},
		//				{346, 533785308},
		//				{346, 557140241},
		//				{346, 577072649},
		//				{346, 577810474},
		//				{346, 675077614},
		//				{346, 681169528},
		//				{346, 692778428},
		//				{346, 726979975},
		//				{346, 942926747},
		//				{346, 945381192},
		//				{346, 957327275},
		//				{346, 976052433},
		//				{346, 978674567},
		//				{347, 593537146},
		//				{347, 808097555},
		//				{347, 933236570},
		//				{348, 435365767},
		//				{348, 662842594},
		//				{348, 711455226},
		//				{348, 898229853},
		//				{349, 911813648},
		//				{350, 565997541},
		//				{353, 694713647},
		//				{355, 521710955},
		//				{355, 528596665},
		//				{355, 537577082},
		//				{355, 812379894},
		//				{355, 834331648},
		//				{355, 851005315},
		//				{355, 868365169},
		//				{355, 869885212},
		//				{355, 878106657},
		//				{355, 926901164},
		//				{358, 432920252},
		//				{358, 491710899},
		//				{358, 522403306},
		//				{358, 526002351},
		//				{358, 581506296},
		//				{358, 624573971},
		//				{358, 840204000},
		//				{359, 511892006},
		//				{359, 545670708},
		//				{359, 586974383},
		//				{359, 637436624},
		//				{359, 705211891},
		//				{359, 767369939},
		//				{360, 643798619},
		//				{360, 910492448},
		//				{362, 297677561},
		//				{362, 349922130},
		//				{362, 352319663},
		//				{363, 291690961},
		//				{363, 297677561},
		//				{363, 349922130},
		//				{363, 352319663},
		//				{363, 732855463},
		//				{363, 732887209},
		//				{363, 960706991},
		//				{364, 487308650},
		//				{364, 516567679},
		//				{364, 596795873},
		//				{364, 627525184},
		//				{364, 732855463},
		//				{364, 732887209},
		//				{364, 844513428},
		//				{364, 850454775},
		//				{364, 960706991},
		//				{364, 966710568},
		//				{365, 487308650},
		//				{365, 516567679},
		//				{365, 844513428},
		//				{365, 918434703},
		//				{365, 966710568},
		//				{366, 719039637},
		//				{366, 885819965},
		//				{366, 918434703},
		//				{367, 885819965},
		//				{368, 814977594},
		//				{368, 849095637},
		//				{368, 907047432},
		//				{368, 961677403},
		//				{369, 595359155},
		//				{369, 814977594},
		//				{369, 849095637},
		//				{369, 907047432},
		//				{369, 961677403},
		//				{370, 355736613},
		//				{370, 393648165},
		//				{370, 448509859},
		//				{370, 449942641},
		//				{370, 449948945},
		//				{370, 470062232},
		//				{370, 507330820},
		//				{370, 508501651},
		//				{370, 508502547},
		//				{370, 679956674},
		//				{370, 695805471},
		//				{370, 934099083},
		//				{371, 692703839},
		//				{371, 797000334},
		//				{372, 815117943},
		//				{372, 815118690},
		//				{372, 815122318},
		//				{372, 836007687},
		//				{372, 839727240}};
	}
}
